var MosaicGen=(function(){var U=100;function b(a){return Math.random()*a}function D(a,n){return n=n||1,Math.ceil(a*n)/n}function F(a,n){return a+Math.random()*(n-a)}function N(a,n,f){return Math.max(n,Math.min(f,a))}function m(a,n,f){for(var e=f*f,t=0;t<n.length;t++){var r=a.x-n[t].x,o=a.y-n[t].y;if(r*r+o*o<e)return!1}return!0}function V(a){for(var n=a.width,f=a.height,e=a.pixels,t=[],r=0;r<f;r++){t[r]=[];for(var o=0;o<n;o++){for(var l=0,v=0,u=-1;u<=1;u++)for(var h=-1;h<=1;h++){var c=N(o+h,0,n-1),M=N(r+u,0,f-1),g=(M*n+c)*4,p=(e[g]+e[g+1]+e[g+2])/3,w=h===0?0:u===0?2*h:h,S=u===0?0:h===0?2*u:u;l+=p*w,v+=p*S}t[r][o]=Math.sqrt(l*l+v*v)}}return{edgeStrength:t}}function A(a,n,f){var e=a.width,t=a.height,r=[],o=Math.max(e,t)/15;r.push({x:0,y:0},{x:e-1,y:0},{x:0,y:t-1},{x:e-1,y:t-1});for(var l=2,v=1;v<l;v++){var u=v/l;r.push({x:u*(e-1),y:0},{x:u*(e-1),y:t-1}),r.push({x:0,y:u*(t-1)},{x:e-1,y:u*(t-1)})}for(var h=0,c=0;c<t;c++)for(var M=0;M<e;M++)h+=n.edgeStrength[c][M]+1;var g=Math.floor(f*.6),p=f-g,w=30;function S(){for(var z=b(h),R=0,E=0;E<t;E++)for(var C=0;C<e;C++)if(R+=n.edgeStrength[E][C]+1,R>=z)return{x:C,y:E};return{x:0,y:0}}for(var v=0;v<g;v++){for(var k=!1,i=0;i<w;i++){var s=S();if(m(s,r,o)){r.push(s),k=!0;break}}if(!k&&v>g*.5)for(var i=0;i<w;i++){var s=S();if(m(s,r,o*.7)){r.push(s);break}}}for(var v=0;v<p;v++){for(var k=!1,i=0;i<w;i++){var s={x:F(o,e-o),y:F(o,t-o)};if(m(s,r,o)){r.push(s),k=!0;break}}if(!k)for(var i=0;i<w;i++){var s={x:b(e),y:b(t)};if(m(s,r,o*.6)){r.push(s);break}}}return r}function G(a,n,f){for(var e=[],t=0;t<f;t++){e[t]=[];for(var r=0;r<n;r++){for(var o=1/0,l=-1,v=0;v<a.length;v++){var u=r-a[v].x,h=t-a[v].y,c=u*u+h*h;c<o&&(o=c,l=v)}e[t][r]=l}}return{map:e,seeds:a}}function O(a){if(a.length<3)return a;for(var n=a[0],f=1;f<a.length;f++){var e=a[f];(e.y<n.y||e.y===n.y&&e.x<n.x)&&(n=e)}var t=a.filter(function(u){return u!==n}).sort(function(u,h){return Math.atan2(u.y-n.y,u.x-n.x)-Math.atan2(h.y-n.y,h.x-n.x)});t.unshift(n);for(var r=[t[0],t[1]],f=2;f<t.length;f++){for(;r.length>=2;){var o=r[r.length-2],l=r[r.length-1],v=t[f];if((l.x-o.x)*(v.y-o.y)-(l.y-o.y)*(v.x-o.x)<=0)r.pop();else break}r.push(t[f])}return r}function W(a,n,f,e){for(var t=new Set,r=0;r<e;r++)for(var o=0;o<f;o++)if(a[r][o]===n){var l=o===0||o===f-1||r===0||r===e-1;if(!l){for(var v=-1;v<=1&&!l;v++)for(var u=-1;u<=1&&!l;u++)if(!(u===0&&v===0)){var h=o+u,c=r+v;h>=0&&h<f&&c>=0&&c<e&&a[c][h]!==n&&(l=!0)}}l&&t.add(o+","+r)}if(t.size===0)return[];var M=[];return t.forEach(function(g){var p=g.split(",");M.push({x:+p[0],y:+p[1]})}),O(M)}function _(a,n,f){for(var e=0,t=0,r=0,o=0,l=f.pixels,v=f.width,u=0;u<f.height;u++)for(var h=0;h<v;h++)if(a[u][h]===n){var c=(u*v+h)*4;e+=l[c],t+=l[c+1],r+=l[c+2],o++}return o===0?"rgb(128,128,128)":"rgb("+D(e/o,U)+","+D(t/o,U)+","+D(r/o,U)+")"}function q(a,n){for(var f=[],e=0;e<a.seeds.length;e++){var t=W(a.map,e,n.width,n.height);t.length<3||f.push({vertices:t,color:_(a.map,e,n)})}return f}return{generateVoronoiMosaic:function(a,n){var f=V(a),e=A(a,f,n),t=G(e,a.width,a.height);return q(t,a)}}})();
