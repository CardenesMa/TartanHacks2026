const LOADING_TIME=2e3;(function(){function C(a,e,t,l){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){var i=document.createElement("canvas"),r=i.getContext("2d");i.width=e,i.height=t;var c=n.width/n.height,s=e/t,d,v,u,m;c>s?(m=n.height,u=m*s,d=(n.width-u)/2,v=0):(u=n.width,m=u/s,d=0,v=(n.height-m)/2),r.drawImage(n,d,v,u,m,0,0,e,t);var E=r.getImageData(0,0,e,t);l({width:e,height:t,pixels:E.data})},n.onerror=function(){l(null)},n.src=a}function A(a){for(var e=a.map(function(c){return{vertices:c.vertices.map(function(s){return{x:s.x,y:s.y}}),color:c.color}}),t=e.length,l={},n=t-1;n>0;n--){var i=Math.floor(Math.random()*(n+1)),r=e[n].color;e[n].color=e[i].color,e[i].color=r,l[n]=!0,l[i]=!0}for(var n=0;n<t;n++)if(!l[n]){var i=(n+1)%t,r=e[n].color;e[n].color=e[i].color,e[i].color=r}return e}function B(a,e){for(var t=0;t<a.length;t++)if(a[t].color!==e[t].color)return!1;return!0}var S=["home","game","win"];function y(a){S.forEach(function(e){document.getElementById(e).classList.toggle("hidden",e!==a)})}var o={imageData:null,difficulty:"medium",originalCells:[],scrambledCells:[],selectedIndex:null,showHint:!1,gamePhase:"intro"},h="http://www.w3.org/2000/svg";function p(a){return a.map(function(e){return e.x+","+e.y}).join(" ")}function k(){var a=document.getElementById("original-svg");a.innerHTML="",o.originalCells.forEach(function(e){var t=document.createElementNS(h,"polygon");t.setAttribute("points",p(e.vertices)),t.setAttribute("fill",e.color),t.setAttribute("stroke","none"),a.appendChild(t)})}function g(){var a=document.getElementById("scrambled-svg");a.innerHTML="";var e=o.showHint?o.scrambledCells.map(function(t,l){return t.color!==o.originalCells[l].color}):[];o.scrambledCells.forEach(function(t,l){var n=document.createElementNS(h,"g");n.classList.add("cell-g"),o.gamePhase==="playing"&&n.classList.add("interactive"),o.selectedIndex===l&&n.classList.add("selected");var i=document.createElementNS(h,"polygon");if(i.setAttribute("points",p(t.vertices)),i.setAttribute("fill",t.color),o.selectedIndex===l?(i.setAttribute("stroke","var(--primary)"),i.setAttribute("stroke-width","3")):o.showHint&&e[l]?(i.setAttribute("stroke","#FFD700"),i.setAttribute("stroke-width","2.5"),i.style.filter="drop-shadow(0 0 6px rgba(255, 215, 0, 0.2))"):i.setAttribute("stroke","none"),i.addEventListener("click",function(){o.gamePhase==="playing"&&(Audio.tileClick(),x(l))}),n.appendChild(i),o.showHint&&e[l]){var r=document.createElementNS(h,"polygon");r.setAttribute("points",p(t.vertices)),r.setAttribute("fill","rgba(255, 215, 0, 0.6)"),r.setAttribute("stroke","none"),r.setAttribute("pointer-events","none"),n.appendChild(r)}a.appendChild(n)})}function x(a){if(o.showHint=!1,o.selectedIndex===null)o.selectedIndex=a,g();else if(o.selectedIndex===a)o.selectedIndex=null,g();else{var e=o.selectedIndex,t=a,l=document.getElementById("scrambled-svg"),n=l.querySelectorAll(".cell-g")[e].querySelector("polygon"),i=l.querySelectorAll(".cell-g")[t].querySelector("polygon");n.style.transition="opacity 0.15s ease-out",i.style.transition="opacity 0.15s ease-out",n.style.opacity="0.3",i.style.opacity="0.3",setTimeout(function(){Audio.swap();var r=o.scrambledCells[e].color;o.scrambledCells[e].color=o.scrambledCells[t].color,o.scrambledCells[t].color=r,o.selectedIndex=null,g();var c=document.getElementById("scrambled-svg"),s=c.querySelectorAll(".cell-g")[e].querySelector("polygon"),d=c.querySelectorAll(".cell-g")[t].querySelector("polygon");s.style.transition="none",d.style.transition="none",s.style.opacity="0.3",d.style.opacity="0.3",requestAnimationFrame(function(){s.style.transition="opacity 0.3s ease-out, filter 0.3s ease-out",d.style.transition="opacity 0.3s ease-out, filter 0.3s ease-out",s.style.opacity="1",d.style.opacity="1",s.style.filter="brightness(1.3)",d.style.filter="brightness(1.3)",setTimeout(function(){s.style.filter="none",d.style.filter="none"},300)}),setTimeout(function(){B(o.scrambledCells,o.originalCells)&&T()},400)},150)}}function D(){o.showHint=!o.showHint,document.getElementById("hint-btn").textContent=(o.showHint?"Hide":"Show")+" Differences",g()}function M(){var a=document.getElementById("original-wrap"),e=document.getElementById("scrambled-wrap"),t=document.getElementById("hint-btn");a.style.display="none",e.style.display="none",t.classList.add("hidden"),k(),setTimeout(function(){a.style.display="",a.classList.add("pop-in")},100),setTimeout(function(){a.classList.add("glide-up")},800);var l=o.scrambledCells.length;setTimeout(function(){e.style.display="",e.classList.add("fade-in"),g();var n=document.getElementById("scrambled-svg"),i=n.querySelectorAll(".cell-g");i.forEach(function(r,c){var s=r.querySelector("polygon");s.style.opacity="0",s.style.transition="opacity 0.3s ease "+c*15+"ms",requestAnimationFrame(function(){s.style.opacity="1"})})},1500),setTimeout(function(){o.gamePhase="playing",t.classList.remove("hidden"),g()},1500+l*15+500)}function T(){y("win"),H()}function H(){var a=["#5E3023","#F3E9DC","#FFD700","#C08552"],e=document.getElementById("confetti");e.innerHTML="";for(var t=0;t<50;t++){var l=document.createElement("div");l.className="confetti",l.style.left=Math.random()*100+"%",l.style.backgroundColor=a[Math.floor(Math.random()*a.length)],l.style.animationDelay=Math.random()*3+"s",l.style.animationDuration=2+Math.random()*2+"s",e.appendChild(l),(function(n){setTimeout(function(){n.remove()},5e3)})(l)}}function q(){var a=document.createElement("canvas");a.width=600,a.height=600;var e=a.getContext("2d");e&&(o.originalCells.forEach(function(t){e.fillStyle=t.color,e.beginPath(),t.vertices.forEach(function(l,n){n===0?e.moveTo(l.x*3,l.y*3):e.lineTo(l.x*3,l.y*3)}),e.closePath(),e.fill()}),a.toBlob(function(t){if(t){var l=URL.createObjectURL(t),n=document.createElement("a");n.href=l,n.download="mosaic-puzzle.png",n.click(),URL.revokeObjectURL(l)}}))}function b(a){o.difficulty=a,o.selectedIndex=null,o.showHint=!1,o.gamePhase="intro",document.getElementById("loading").style.display="flex",C(o.imageData,200,200,function(e){if(!e){y("home");return}var t=a==="easy"?5:a==="hard"?200:50;o.originalCells=MosaicGen.generateVoronoiMosaic(e,t),o.scrambledCells=A(o.originalCells),setTimeout(function(){document.getElementById("loading").style.display="none",y("game"),M()},2e3)})}function w(){var a=document.getElementById("file-input"),e=document.getElementById("upload-area"),t=document.getElementById("preview-area"),l=document.getElementById("preview-img"),n=document.getElementById("change-btn"),i=document.getElementById("btn-easy"),r=document.getElementById("btn-medium"),c=document.getElementById("btn-hard"),s=document.getElementById("hint-btn"),d=document.getElementById("download-btn"),v=document.getElementById("play-again-btn");function u(f){o.imageData=f,l.src=f,e.classList.add("hidden"),t.classList.remove("hidden"),i.disabled=!1,r.disabled=!1,c.disabled=!1}function m(){o.imageData=null,a.value="",e.classList.remove("hidden"),t.classList.add("hidden"),i.disabled=!0,r.disabled=!0,c.disabled=!0}a.addEventListener("change",function(f){var L=f.target.files[0];if(L){var I=new FileReader;I.onload=function(){u(I.result)},I.readAsDataURL(L)}}),n.addEventListener("click",m),i.addEventListener("click",function(){b("easy")}),r.addEventListener("click",function(){b("medium")}),c.addEventListener("click",function(){b("hard")}),s.addEventListener("click",D),d.addEventListener("click",q),v.addEventListener("click",function(){y("home")});var E=document.querySelectorAll("button");E.forEach(function(f){f.addEventListener("click",function(){Audio.buttonClick()})}),y("home")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w):w()})();
