const LOADING_TIME=2e3;(function(){function L(a,e,t,l){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){var r=document.createElement("canvas"),i=r.getContext("2d");r.width=e,r.height=t;var d=n.width/n.height,s=e/t,v,h,c,u;d>s?(u=n.height,c=u*s,v=(n.width-c)/2,h=0):(c=n.width,u=c/s,v=0,h=(n.height-u)/2),i.drawImage(n,v,h,c,u,0,0,e,t);var m=i.getImageData(0,0,e,t);l({width:e,height:t,pixels:m.data})},n.onerror=function(){l(null)},n.src=a}function C(a){for(var e=a.map(function(d){return{vertices:d.vertices.map(function(s){return{x:s.x,y:s.y}}),color:d.color}}),t=e.length,l={},n=t-1;n>0;n--){var r=Math.floor(Math.random()*(n+1)),i=e[n].color;e[n].color=e[r].color,e[r].color=i,l[n]=!0,l[r]=!0}for(var n=0;n<t;n++)if(!l[n]){var r=(n+1)%t,i=e[n].color;e[n].color=e[r].color,e[r].color=i}return e}function B(a,e){for(var t=0;t<a.length;t++)if(a[t].color!==e[t].color)return!1;return!0}var x=["home","game","win"];function g(a){x.forEach(function(e){document.getElementById(e).classList.toggle("hidden",e!==a)})}var o={imageData:null,difficulty:"medium",originalCells:[],scrambledCells:[],selectedIndex:null,showHint:!1,gamePhase:"intro"},y="http://www.w3.org/2000/svg";function I(a){return a.map(function(e){return e.x+","+e.y}).join(" ")}function k(){var a=document.getElementById("original-svg");a.innerHTML="",o.originalCells.forEach(function(e){var t=document.createElementNS(y,"polygon");t.setAttribute("points",I(e.vertices)),t.setAttribute("fill",e.color),t.setAttribute("stroke","none"),a.appendChild(t)})}function f(){var a=document.getElementById("scrambled-svg");a.innerHTML="";var e=o.showHint?o.scrambledCells.map(function(t,l){return t.color!==o.originalCells[l].color}):[];o.scrambledCells.forEach(function(t,l){var n=document.createElementNS(y,"g");n.classList.add("cell-g"),o.gamePhase==="playing"&&n.classList.add("interactive"),o.selectedIndex===l&&n.classList.add("selected");var r=document.createElementNS(y,"polygon");r.setAttribute("points",I(t.vertices)),r.setAttribute("fill",t.color),o.selectedIndex===l?(r.setAttribute("stroke","var(--secondary)"),r.setAttribute("stroke-width","2")):o.showHint&&e[l]?(r.setAttribute("stroke","#FFD700"),r.setAttribute("stroke-width","1.5"),r.style.filter="drop-shadow(0 0 4px #FFD700)"):r.setAttribute("stroke","none"),r.addEventListener("click",function(){o.gamePhase==="playing"&&A(l)}),n.appendChild(r),a.appendChild(n)})}function A(a){if(o.showHint=!1,o.selectedIndex===null)o.selectedIndex=a;else if(o.selectedIndex===a)o.selectedIndex=null;else{var e=o.selectedIndex,t=a,l=o.scrambledCells[e].color;if(o.scrambledCells[e].color=o.scrambledCells[t].color,o.scrambledCells[t].color=l,o.selectedIndex=null,B(o.scrambledCells,o.originalCells)){f(),setTimeout(H,500);return}}f()}function D(){o.showHint=!o.showHint,document.getElementById("hint-btn").textContent=(o.showHint?"Hide":"Show")+" Differences",f()}function M(){var a=document.getElementById("original-wrap"),e=document.getElementById("scrambled-wrap"),t=document.getElementById("hint-btn");a.style.display="none",e.style.display="none",t.classList.add("hidden"),k(),setTimeout(function(){a.style.display="",a.classList.add("pop-in")},100),setTimeout(function(){a.classList.add("glide-up")},800);var l=o.scrambledCells.length;setTimeout(function(){e.style.display="",e.classList.add("fade-in"),f();var n=document.getElementById("scrambled-svg"),r=n.querySelectorAll(".cell-g");r.forEach(function(i,d){var s=i.querySelector("polygon");s.style.opacity="0",s.style.transition="opacity 0.3s ease "+d*15+"ms",requestAnimationFrame(function(){s.style.opacity="1"})})},1500),setTimeout(function(){o.gamePhase="playing",t.classList.remove("hidden"),f()},1500+l*15+500)}function H(){g("win"),S()}function S(){var a=["#5E3023","#F3E9DC","#FFD700","#C08552"],e=document.getElementById("confetti");e.innerHTML="";for(var t=0;t<50;t++){var l=document.createElement("div");l.className="confetti",l.style.left=Math.random()*100+"%",l.style.backgroundColor=a[Math.floor(Math.random()*a.length)],l.style.animationDelay=Math.random()*3+"s",l.style.animationDuration=2+Math.random()*2+"s",e.appendChild(l),(function(n){setTimeout(function(){n.remove()},5e3)})(l)}}function T(){var a=document.createElement("canvas");a.width=600,a.height=600;var e=a.getContext("2d");e&&(o.originalCells.forEach(function(t){e.fillStyle=t.color,e.beginPath(),t.vertices.forEach(function(l,n){n===0?e.moveTo(l.x*3,l.y*3):e.lineTo(l.x*3,l.y*3)}),e.closePath(),e.fill()}),a.toBlob(function(t){if(t){var l=URL.createObjectURL(t),n=document.createElement("a");n.href=l,n.download="mosaic-puzzle.png",n.click(),URL.revokeObjectURL(l)}}))}function p(a){o.difficulty=a,o.selectedIndex=null,o.showHint=!1,o.gamePhase="intro",document.getElementById("loading").style.display="flex",L(o.imageData,200,200,function(e){if(!e){g("home");return}var t=a==="easy"?20:a==="hard"?200:50;o.originalCells=MosaicGen.generateVoronoiMosaic(e,t),o.scrambledCells=C(o.originalCells),setTimeout(function(){document.getElementById("loading").style.display="none",g("game"),M()},2e3)})}function b(){var a=document.getElementById("file-input"),e=document.getElementById("upload-area"),t=document.getElementById("preview-area"),l=document.getElementById("preview-img"),n=document.getElementById("change-btn"),r=document.getElementById("btn-easy"),i=document.getElementById("btn-medium"),d=document.getElementById("btn-hard"),s=document.getElementById("hint-btn"),v=document.getElementById("download-btn"),h=document.getElementById("play-again-btn");function c(m){o.imageData=m,l.src=m,e.classList.add("hidden"),t.classList.remove("hidden"),r.disabled=!1,i.disabled=!1,d.disabled=!1}function u(){o.imageData=null,a.value="",e.classList.remove("hidden"),t.classList.add("hidden"),r.disabled=!0,i.disabled=!0,d.disabled=!0}a.addEventListener("change",function(m){var w=m.target.files[0];if(w){var E=new FileReader;E.onload=function(){c(E.result)},E.readAsDataURL(w)}}),n.addEventListener("click",u),r.addEventListener("click",function(){p("easy")}),i.addEventListener("click",function(){p("medium")}),d.addEventListener("click",function(){p("hard")}),s.addEventListener("click",D),v.addEventListener("click",T),h.addEventListener("click",function(){g("home")}),g("home")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b):b()})();
