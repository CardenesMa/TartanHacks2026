(function(){function L(a,e,t,r){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){var i=document.createElement("canvas"),l=i.getContext("2d");i.width=e,i.height=t;var d=n.width/n.height,s=e/t,v,h,c,u;d>s?(u=n.height,c=u*s,v=(n.width-c)/2,h=0):(c=n.width,u=c/s,v=0,h=(n.height-u)/2),l.drawImage(n,v,h,c,u,0,0,e,t);var m=l.getImageData(0,0,e,t);r({width:e,height:t,pixels:m.data})},n.onerror=function(){r(null)},n.src=a}function C(a){for(var e=a.map(function(d){return{vertices:d.vertices.map(function(s){return{x:s.x,y:s.y}}),color:d.color}}),t=e.length,r={},n=t-1;n>0;n--){var i=Math.floor(Math.random()*(n+1)),l=e[n].color;e[n].color=e[i].color,e[i].color=l,r[n]=!0,r[i]=!0}for(var n=0;n<t;n++)if(!r[n]){var i=(n+1)%t,l=e[n].color;e[n].color=e[i].color,e[i].color=l}return e}function B(a,e){for(var t=0;t<a.length;t++)if(a[t].color!==e[t].color)return!1;return!0}var x=["home","game","win"];function f(a){x.forEach(function(e){document.getElementById(e).classList.toggle("hidden",e!==a)})}var o={imageData:null,difficulty:"medium",originalCells:[],scrambledCells:[],selectedIndex:null,showHint:!1,gamePhase:"intro"},y="http://www.w3.org/2000/svg";function b(a){return a.map(function(e){return e.x+","+e.y}).join(" ")}function k(){var a=document.getElementById("original-svg");a.innerHTML="",o.originalCells.forEach(function(e){var t=document.createElementNS(y,"polygon");t.setAttribute("points",b(e.vertices)),t.setAttribute("fill",e.color),t.setAttribute("stroke","none"),a.appendChild(t)})}function g(){var a=document.getElementById("scrambled-svg");a.innerHTML="";var e=o.showHint?o.scrambledCells.map(function(t,r){return t.color!==o.originalCells[r].color}):[];o.scrambledCells.forEach(function(t,r){var n=document.createElementNS(y,"g");n.classList.add("cell-g"),o.gamePhase==="playing"&&n.classList.add("interactive"),o.selectedIndex===r&&n.classList.add("selected");var i=document.createElementNS(y,"polygon");i.setAttribute("points",b(t.vertices)),i.setAttribute("fill",t.color),o.selectedIndex===r?(i.setAttribute("stroke","var(--secondary)"),i.setAttribute("stroke-width","2")):o.showHint&&e[r]?(i.setAttribute("stroke","#FFD700"),i.setAttribute("stroke-width","1.5"),i.style.filter="drop-shadow(0 0 4px #FFD700)"):i.setAttribute("stroke","none"),i.addEventListener("click",function(){o.gamePhase==="playing"&&A(r)}),n.appendChild(i),a.appendChild(n)})}function A(a){if(o.showHint=!1,o.selectedIndex===null)o.selectedIndex=a;else if(o.selectedIndex===a)o.selectedIndex=null;else{var e=o.selectedIndex,t=a,r=o.scrambledCells[e].color;if(o.scrambledCells[e].color=o.scrambledCells[t].color,o.scrambledCells[t].color=r,o.selectedIndex=null,B(o.scrambledCells,o.originalCells)){g(),setTimeout(M,500);return}}g()}function D(){o.showHint=!o.showHint,document.getElementById("hint-btn").textContent=(o.showHint?"Hide":"Show")+" Differences",g()}function H(){var a=document.getElementById("original-wrap"),e=document.getElementById("scrambled-wrap"),t=document.getElementById("hint-btn");a.style.display="none",e.style.display="none",t.classList.add("hidden"),k(),setTimeout(function(){a.style.display="",a.classList.add("pop-in")},100),setTimeout(function(){a.classList.add("glide-up")},800);var r=o.scrambledCells.length;setTimeout(function(){e.style.display="",e.classList.add("fade-in"),g();var n=document.getElementById("scrambled-svg"),i=n.querySelectorAll(".cell-g");i.forEach(function(l,d){var s=l.querySelector("polygon");s.style.opacity="0",s.style.transition="opacity 0.3s ease "+d*15+"ms",requestAnimationFrame(function(){s.style.opacity="1"})})},1500),setTimeout(function(){o.gamePhase="playing",t.classList.remove("hidden"),g()},1500+r*15+500)}function M(){f("win"),S()}function S(){var a=["#5E3023","#F3E9DC","#FFD700","#C08552"],e=document.getElementById("confetti");e.innerHTML="";for(var t=0;t<50;t++){var r=document.createElement("div");r.className="confetti",r.style.left=Math.random()*100+"%",r.style.backgroundColor=a[Math.floor(Math.random()*a.length)],r.style.animationDelay=Math.random()*3+"s",r.style.animationDuration=2+Math.random()*2+"s",e.appendChild(r),(function(n){setTimeout(function(){n.remove()},5e3)})(r)}}function T(){var a=document.createElement("canvas");a.width=600,a.height=600;var e=a.getContext("2d");e&&(o.originalCells.forEach(function(t){e.fillStyle=t.color,e.beginPath(),t.vertices.forEach(function(r,n){n===0?e.moveTo(r.x*3,r.y*3):e.lineTo(r.x*3,r.y*3)}),e.closePath(),e.fill()}),a.toBlob(function(t){if(t){var r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download="mosaic-puzzle.png",n.click(),URL.revokeObjectURL(r)}}))}function p(a){o.difficulty=a,o.selectedIndex=null,o.showHint=!1,o.gamePhase="intro",document.getElementById("loading").hidden=!1,L(o.imageData,200,200,function(e){if(!e){f("home");return}var t=a==="easy"?20:a==="hard"?200:50;o.originalCells=MosaicGen.generateVoronoiMosaic(e,t),o.scrambledCells=C(o.originalCells),setTimeout(function(){f("game"),H()},2e3)})}function I(){var a=document.getElementById("file-input"),e=document.getElementById("upload-area"),t=document.getElementById("preview-area"),r=document.getElementById("preview-img"),n=document.getElementById("change-btn"),i=document.getElementById("btn-easy"),l=document.getElementById("btn-medium"),d=document.getElementById("btn-hard"),s=document.getElementById("hint-btn"),v=document.getElementById("download-btn"),h=document.getElementById("play-again-btn");function c(m){o.imageData=m,r.src=m,e.classList.add("hidden"),t.classList.remove("hidden"),i.disabled=!1,l.disabled=!1,d.disabled=!1}function u(){o.imageData=null,a.value="",e.classList.remove("hidden"),t.classList.add("hidden"),i.disabled=!0,l.disabled=!0,d.disabled=!0}a.addEventListener("change",function(m){var w=m.target.files[0];if(w){var E=new FileReader;E.onload=function(){c(E.result)},E.readAsDataURL(w)}}),n.addEventListener("click",u),i.addEventListener("click",function(){p("easy")}),l.addEventListener("click",function(){p("medium")}),d.addEventListener("click",function(){p("hard")}),s.addEventListener("click",D),v.addEventListener("click",T),h.addEventListener("click",function(){f("home")}),f("home")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I()})();
